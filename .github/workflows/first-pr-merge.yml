name: First PR Merge Comment

on:
  pull_request:
    types: [closed]

jobs:
  comment-on-first-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
    - name: Check if this is the user's first merged PR
      id: check_first_pr
      uses: actions/github-script@v7
      with:
        script: |
          const prAuthor = context.payload.pull_request.user.login;
          const owner = context.repo.owner;
          const repo = context.repo.repo;

          const response = await fetch(`https://api.github.com/search/issues?q=repo:${owner}/${repo}+type:pr+state:closed+author:${prAuthor}+is:merged`);

          const data = await response.json();
          const mergedCount = data.total_count;

          core.setOutput('prAuthor', prAuthor);
          core.setOutput('mergedCount', mergedCount);

    - name: Comment on the first merged PR
      if: steps.check_first_pr.outputs.mergedCount == '3'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const prAuthor = core.getInput('prAuthor');
          const commentBody = `Congratulations @${prAuthor} on your first merged pull request! ðŸŽ‰ Thank you for your contribution!`;

           await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              })
